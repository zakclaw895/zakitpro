---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';
import ArticleMetadata from '../components/ArticleMetadata.astro';
import DifficultyBadge from '../components/DifficultyBadge.astro';
import RelatedArticles from '../components/RelatedArticles.astro';
import { formatDate, calculateReadingTime } from '../utils';

const { frontmatter, headings } = Astro.props;

// Calculate reading time
const readingTime = calculateReadingTime(frontmatter.body || '');

const pillarNames = {
  troubleshooting: 'Windows Troubleshooting',
  scripting: 'Scripting & Automation',
  deployment: 'Deployment & Imaging',
  security: 'Endpoint Security',
  packaging: 'App Packaging',
  career: 'Career & Craft'
};

const typeLabels = {
  'war-story': 'War Story',
  'deep-dive': 'Deep Dive',
  'how-to': 'How-To',
  'script-drop': 'Script Drop',
  'error-reference': 'Error Reference',
  'opinion': 'Opinion',
  'career-guide': 'Career Guide'
};
---

<BaseLayout title={frontmatter.title} description={frontmatter.description}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 mb-6">
      <a href="/" class="hover:text-accent">Home</a>
      <span>/</span>
      <a href={`/${frontmatter.pillar}/`} class="hover:text-accent">{pillarNames[frontmatter.pillar]}</a>
      <span>/</span>
      <span class="text-gray-900 dark:text-white">{frontmatter.title}</span>
    </nav>
    
    <div class="lg:grid lg:grid-cols-4 lg:gap-8">
      <!-- Left Sidebar - Table of Contents (Desktop) -->
      {headings && headings.length >= 3 && (
        <aside class="hidden lg:block lg:col-span-1">
          <div class="sticky top-24">
            <TableOfContents headings={headings} />
          </div>
        </aside>
      )}
      
      <!-- Main Content -->
      <article class="lg:col-span-2">
        <!-- Article Header -->
        <header class="mb-8">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <span class="text-sm text-gray-600 dark:text-gray-400">{formatDate(frontmatter.publishedAt)}</span>
            <span class="text-gray-400">â€¢</span>
            <span class="text-sm text-gray-600 dark:text-gray-400">{readingTime}</span>
            <DifficultyBadge difficulty={frontmatter.difficulty} />
            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
              {typeLabels[frontmatter.type]}
            </span>
          </div>
          
          <h1 class="text-3xl md:text-4xl font-heading font-bold mb-4">{frontmatter.title}</h1>
          
          {frontmatter.description && (
            <p class="text-lg text-gray-600 dark:text-gray-400">{frontmatter.description}</p>
          )}
          
          {frontmatter.updatedAt && (
            <p class="text-sm text-gray-500 mt-2">Updated: {formatDate(frontmatter.updatedAt)}</p>
          )}
        </header>
        
        <!-- Article Content -->
        <div class="prose dark:prose-invert max-w-none">
          <slot />
        </div>
        
        <!-- Tags -->
        {frontmatter.tags && frontmatter.tags.length > 0 && (
          <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-wrap gap-2">
              {frontmatter.tags.map(tag => (
                <a href={`/tags/${tag}`} class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-800 rounded-full text-gray-700 dark:text-gray-300 hover:bg-accent hover:text-white transition-colors">
                  #{tag}
                </a>
              ))}
            </div>
          </div>
        )}
        
        <!-- Related Articles -->
        <RelatedArticles currentSlug={frontmatter.slug} pillar={frontmatter.pillar} tags={frontmatter.tags} />
        
        <!-- Giscus Comments -->
        <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
          <script src="https://giscus.app/client.js"
            data-repo="your-username/zakitpro-comments"
            data-repo-id="YOUR_REPO_ID"
            data-category="Comments"
            data-category-id="YOUR_CATEGORY_ID"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="preferred_color_scheme"
            data-lang="en"
            crossorigin="anonymous"
            async>
          </script>
        </div>
      </article>
      
      <!-- Right Sidebar - Metadata (Desktop) -->
      <aside class="hidden lg:block lg:col-span-1">
        <div class="sticky top-24">
          <ArticleMetadata 
            pillar={frontmatter.pillar}
            difficulty={frontmatter.difficulty}
            type={frontmatter.type}
            publishedAt={frontmatter.publishedAt}
            updatedAt={frontmatter.updatedAt}
          />
        </div>
      </aside>
    </div>
  </div>
  
  <!-- Mobile TOC Button -->
  {headings && headings.length >= 3 && (
    <button 
      id="toc-mobile-trigger"
      class="fixed bottom-6 right-6 lg:hidden z-30 p-3 bg-accent text-white rounded-full shadow-lg"
      aria-label="Table of Contents"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
      </svg>
    </button>
  )}
</BaseLayout>

<style>
  /* Additional article-specific styles */
  article :global(pre) {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
  }
  
  article :global(pre .language-label) {
    position: absolute;
    top: 0;
    right: 0;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #94a3b8;
    background: #1e293b;
    border-bottom-left-radius: 0.5rem;
  }
  
  article :global(.copy-button) {
    position: absolute;
    top: 0.5rem;
    right: 4rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background: #334155;
    color: #e2e8f0;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
  }
  
  article :global(pre:hover .copy-button) {
    opacity: 1;
  }
  
  article :global(.line-numbers) {
    counter-reset: line;
  }
  
  article :global(.line-numbers .line) {
    display: block;
  }
  
  article :global(.line-numbers .line::before) {
    counter-increment: line;
    content: counter(line);
    display: inline-block;
    width: 2rem;
    margin-right: 1rem;
    text-align: right;
    color: #64748b;
    -webkit-user-select: none;
  }
</style>
