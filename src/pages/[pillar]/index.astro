---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import ArticleCard from '../../components/ArticleCard.astro';
import DifficultyBadge from '../../components/DifficultyBadge.astro';

export async function getStaticPaths() {
  const pillars = ['troubleshooting', 'scripting', 'deployment', 'security', 'packaging', 'career'];
  return pillars.map(pillar => ({
    params: { pillar }
  }));
}

const { pillar } = Astro.params;

const pillarNames = {
  troubleshooting: 'Windows Troubleshooting',
  scripting: 'Scripting & Automation',
  deployment: 'Deployment & Imaging',
  security: 'Endpoint Security',
  packaging: 'App Packaging',
  career: 'Career & Craft'
};

const pillarDescriptions = {
  troubleshooting: 'Boot failures, BSOD, event log forensics, profile corruption, error codes',
  scripting: 'PowerShell, Graph API, task automation, scheduled jobs',
  deployment: 'Autopilot, WinPE, MDT, driver injection, provisioning',
  security: 'CIS benchmarks, LAPS, Defender for Endpoint, BitLocker, Conditional Access',
  packaging: 'Win32/Intune packaging, PSADT, silent installs, detection rules',
  career: 'Career progression, lab setup, cert roadmaps, documentation, tooling'
};

// Get all articles for this pillar
const allArticles = await getCollection('articles', ({ data }) => !data.draft);
const pillarArticles = allArticles
  .filter(a => a.data.pillar === pillar)
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime());

const difficulties = ['junior', 'mid', 'senior'];
const types = ['war-story', 'deep-dive', 'how-to', 'script-drop', 'error-reference', 'opinion', 'career-guide'];
---

<BaseLayout title={pillarNames[pillar]} description={pillarDescriptions[pillar]}>
  <div class="max-w-6xl mx-auto px-4 py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-heading font-bold mb-4">{pillarNames[pillar]}</h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">{pillarDescriptions[pillar]}</p>
    </div>
    
    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-8">
      <select id="difficulty-filter" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
        <option value="">All Levels</option>
        {difficulties.map(d => (
          <option value={d}>{d.charAt(0).toUpperCase() + d.slice(1)}</option>
        ))}
      </select>
      
      <select id="type-filter" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
        <option value="">All Types</option>
        {types.map(t => (
          <option value={t}>{t.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>
        ))}
      </select>
    </div>
    
    <!-- Articles Grid -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="articles-grid">
      {pillarArticles.length > 0 ? (
        pillarArticles.map(article => (
          <div class="article-item" data-difficulty={article.data.difficulty} data-type={article.data.type}>
            <ArticleCard article={article.data} />
          </div>
        ))
      ) : (
        <p class="text-gray-500 col-span-full">No articles yet. Coming soon!</p>
      )}
    </div>
    
    <!-- Pagination placeholder -->
    {pillarArticles.length > 15 && (
      <div class="mt-8 flex justify-center gap-2">
        <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Previous</button>
        <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Next</button>
      </div>
    )}
  </div>
</BaseLayout>

<script>
  const difficultyFilter = document.getElementById('difficulty-filter');
  const typeFilter = document.getElementById('type-filter');
  const articles = document.querySelectorAll('.article-item');
  
  function filterArticles() {
    const difficulty = difficultyFilter?.value || '';
    const type = typeFilter?.value || '';
    
    articles.forEach(article => {
      const articleDifficulty = article.getAttribute('data-difficulty');
      const articleType = article.getAttribute('data-type');
      
      const matchesDifficulty = !difficulty || articleDifficulty === difficulty;
      const matchesType = !type || articleType === type;
      
      (article as HTMLElement).style.display = matchesDifficulty && matchesType ? 'block' : 'none';
    });
  }
  
  difficultyFilter?.addEventListener('change', filterArticles);
  typeFilter?.addEventListener('change', filterArticles);
</script>
