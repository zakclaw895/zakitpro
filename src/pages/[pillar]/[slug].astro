---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const articles = await getCollection('articles', ({ data }) => !data.draft);
  return articles.map(article => ({
    params: { pillar: article.data.pillar, slug: article.slug },
    props: { article }
  }));
}

const { article } = Astro.props;
const { Content, headings } = await article.render();

const pillarNames = {
  troubleshooting: 'Windows Troubleshooting',
  scripting: 'Scripting & Automation',
  deployment: 'Deployment & Imaging',
  security: 'Endpoint Security',
  packaging: 'App Packaging',
  career: 'Career & Craft'
};

const difficultyColors = {
  junior: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
  mid: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
  senior: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
};

const difficultyLabels = {
  junior: 'Junior (1-3 years)',
  mid: 'Mid-Level (3-5 years)',
  senior: 'Senior (5+ years)'
};

const typeLabels = {
  'war-story': 'War Story',
  'deep-dive': 'Deep Dive',
  'how-to': 'How-To',
  'script-drop': 'Script Drop',
  'error-reference': 'Error Reference',
  'opinion': 'Opinion',
  'career-guide': 'Career Guide'
};
---

<BaseLayout title={article.data.title} description={article.data.description}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 mb-6">
      <a href="/" class="hover:text-accent">Home</a>
      <span>/</span>
      <a href={`/${article.data.pillar}/`} class="hover:text-accent">{pillarNames[article.data.pillar]}</a>
      <span>/</span>
      <span class="text-gray-900 dark:text-white">{article.data.title}</span>
    </nav>
    
    <div class="lg:grid lg:grid-cols-4 lg:gap-8">
      <!-- Left Sidebar - Table of Contents (Desktop) -->
      {headings && headings.filter(h => h.depth >= 2 && h.depth <= 3).length >= 3 && (
        <aside class="hidden lg:block lg:col-span-1">
          <div class="sticky top-24">
            <nav class="text-sm">
              <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">On this page</h4>
              <ul class="space-y-2">
                {headings.filter(h => h.depth >= 2 && h.depth <= 3).map(heading => (
                  <li class={heading.depth === 3 ? 'ml-4' : ''}>
                    <a 
                      href={`#${heading.slug}`}
                      class="text-gray-600 dark:text-gray-400 hover:text-accent transition-colors block py-1"
                    >
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          </div>
        </aside>
      )}
      
      <!-- Main Content -->
      <article class="lg:col-span-2">
        <!-- Article Header -->
        <header class="mb-8">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <span class="text-sm text-gray-600 dark:text-gray-400">
              {new Date(article.data.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </span>
            <span class="text-gray-400">‚Ä¢</span>
            <span class={`inline-block px-2 py-1 text-xs font-medium rounded-full ${difficultyColors[article.data.difficulty]}`}>
              {difficultyLabels[article.data.difficulty]}
            </span>
            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
              {typeLabels[article.data.type]}
            </span>
          </div>
          
          <h1 class="text-3xl md:text-4xl font-heading font-bold mb-4">{article.data.title}</h1>
          
          {article.data.description && (
            <p class="text-lg text-gray-600 dark:text-gray-400">{article.data.description}</p>
          )}
          
          {article.data.updatedAt && (
            <p class="text-sm text-gray-500 mt-2">Updated: {new Date(article.data.updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
          )}
        </header>
        
        <!-- Article Content -->
        <div class="prose dark:prose-invert max-w-none">
          <Content />
        </div>
        
        <!-- Tags -->
        {article.data.tags && article.data.tags.length > 0 && (
          <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-wrap gap-2">
              {article.data.tags.map(tag => (
                <a href={`/tags/${tag}`} class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-800 rounded-full text-gray-700 dark:text-gray-300 hover:bg-accent hover:text-white transition-colors">
                  #{tag}
                </a>
              ))}
            </div>
          </div>
        )}
        
        <!-- Was this helpful? -->
        <div class="mt-8 flex items-center gap-4">
          <span class="text-sm text-gray-600 dark:text-gray-400">Was this helpful?</span>
          <button class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            üëç Yes
          </button>
          <button class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            üëé No
          </button>
        </div>
        
        <!-- Giscus Comments -->
        <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
          <script 
            src="https://giscus.app/client.js"
            data-repo="your-username/zakitpro-comments"
            data-repo-id="YOUR_REPO_ID"
            data-category="Comments"
            data-category-id="YOUR_CATEGORY_ID"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="preferred_color_scheme"
            data-lang="en"
            crossorigin="anonymous"
            async
          >
          </script>
        </div>
      </article>
      
      <!-- Right Sidebar - Metadata (Desktop) -->
      <aside class="hidden lg:block lg:col-span-1">
        <div class="sticky top-24 space-y-6">
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
            <h4 class="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Pillar</h4>
            <a href={`/${article.data.pillar}/`} class="text-accent hover:underline font-medium">
              {pillarNames[article.data.pillar]}
            </a>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
            <h4 class="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Difficulty</h4>
            <span class={`inline-block px-2 py-1 text-xs font-medium rounded-full ${difficultyColors[article.data.difficulty]}`}>
              {difficultyLabels[article.data.difficulty]}
            </span>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
            <h4 class="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Published</h4>
            <p class="text-sm text-gray-700 dark:text-gray-300">
              {new Date(article.data.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </p>
          </div>
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>

<style is:global>
  /* Code block styling */
  .prose pre {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
  }
  
  .prose pre code {
    font-family: 'JetBrains Mono', Consolas, monospace;
    font-size: 0.875rem;
    line-height: 1.7;
  }
  
  /* Line numbers */
  .prose pre[data-line-numbers] {
    counter-reset: line;
  }
  
  .prose pre[data-line-numbers] .line::before {
    counter-increment: line;
    content: counter(line);
    display: inline-block;
    width: 2rem;
    margin-right: 1rem;
    text-align: right;
    color: #64748b;
    -webkit-user-select: none;
  }
  
  /* Copy button */
  .copy-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background: #334155;
    color: #e2e8f0;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
  }
  
  .prose pre:hover .copy-btn {
    opacity: 1;
  }
  
  /* Language label */
  .lang-label {
    position: absolute;
    top: 0;
    right: 0;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #94a3b8;
    background: #1e293b;
    border-bottom-left-radius: 0.5rem;
  }
</style>
